<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge TTS - Android/Touch Fix</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; background: #f4f4f9; max-width: 800px; margin: 0 auto; }
        
        textarea { width: 100%; height: 150px; margin-bottom: 15px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        /* Kiemeljük a listát, mert ez a "trigger" a betöltéshez */
        select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 2px solid #0078d4; background: #fff; font-size: 16px; }
        
        button { border: none; padding: 15px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; color: white; margin-bottom: 10px; width: 100%; }
        
        #speakBtn { background: #0078d4; }
        #stopBtn { background: #d11a2a; }
        
        .status { margin-top: 10px; font-size: 0.9em; color: #555; background: #e0e0e0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

    <h2>Edge TTS (Interakció alapú betöltés)</h2>
    
    <label for="voiceSelect">Válassz hangot (Kattints ide a lista frissítéséhez!):</label>
    <select id="voiceSelect">
        <option value="">Kattints ide a hangok betöltéséhez...</option>
    </select>

    <textarea id="textInput">Szia! Ez a teszt kifejezetten arra készült, hogy mobilon vagy szigorú böngészőkben is betöltse a hangokat, amikor a listára kattintasz.</textarea>

    <button id="speakBtn">Lejátszás</button>
    <button id="stopBtn">Megállítás</button>

    <div class="status" id="statusMsg">Várakozás...</div>

    <script>
        // --- AZ ÁLTALAD KÜLDÖTT LOGIKA INTEGRÁLÁSA ---
        
        const synth = window.speechSynthesis;
        const voiceSelect = document.querySelector('#voiceSelect');
        const statusMsg = document.querySelector('#statusMsg');
        const speakBtn = document.querySelector('#speakBtn');
        const stopBtn = document.querySelector('#stopBtn');
        const textInput = document.querySelector('#textInput');

        let voices = [];

        function populateVoiceList() {
            // Ez a legfontosabb: újra lekérjük a listát
            voices = synth.getVoices();
            
            if (voices.length === 0) {
                // Ha még mindig üres, jelezzük
                statusMsg.textContent = "Még nincsenek hangok (próbálkozz újra)...";
                return;
            }

            // Csak akkor ürítjük és építjük újra, ha van változás vagy még üres volt
            // (Hogy ne villogjon feleslegesen, ha már be van töltve)
            if (voiceSelect.options.length > 1 && voiceSelect.options[1].value !== "") {
                 // Opcionális: itt lehetne return, de a biztonság kedvéért újraépítjük
            }

            voiceSelect.innerHTML = ''; // Lista törlése
            
            // Csak a magyar hangokra szűrünk az elején a teszthez
            const huVoices = voices.filter(v => v.lang.includes('hu') || v.lang.includes('HU'));
            
            // Ha nincs magyar, mutassuk az összeset
            const listToUse = huVoices.length > 0 ? huVoices : voices;

            listToUse.forEach((voice) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`; // Javítva: template literal
                option.value = voice.name;
                
                // Preferáljuk a "Natural" hangokat
                if (voice.name.includes("Natural")) {
                    option.selected = true;
                }
                voiceSelect.appendChild(option);
            });

            statusMsg.textContent = `Siker! ${listToUse.length} hang betöltve (Szűrve: ${huVoices.length > 0 ? 'igen' : 'nem'}).`;
        }

        // --- ANDROID / CHROME FIXEK ---
        
        // 1. Kényszerített inicializálás
        populateVoiceList();

        // 2. Eseményfigyelő (standard)
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // 3. Drasztikus megoldás: Időzítő (fallback)
        setTimeout(() => {
            if (voices.length === 0) {
                console.log("Timeout trigger: hangok újratöltése...");
                populateVoiceList();
            }
        }, 1000);

        // 4. Felhasználói interakcióra való frissítés (EZ A KULCS)
        // Ha rákattint a select-re, akkor is próbálja meg betölteni.
        // Ez "ébreszti fel" a motort Androidon.
        voiceSelect.addEventListener('mousedown', () => {
            console.log("User interaction: mousedown");
            populateVoiceList();
        });
        
        voiceSelect.addEventListener('touchstart', () => {
            console.log("User interaction: touchstart");
            populateVoiceList();
        });

        // --- LEJÁTSZÁS FUNKCIÓK (hogy működjön is a teszt) ---

        speakBtn.addEventListener('click', () => {
            synth.cancel(); // Előző leállítása

            if (textInput.value === '') return;

            const utterance = new SpeechSynthesisUtterance(textInput.value);
            const selectedName = voiceSelect.value;
            
            // Megkeressük a teljes voice objektumot a név alapján
            // Figyelem: a 'voices' tömbben kell keresni, ami az ÖSSZES hangot tartalmazza,
            // nem csak a szűrt listában.
            const selectedVoice = voices.find(v => v.name === selectedName);

            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }

            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            utterance.onstart = () => statusMsg.textContent = "Beszéd folyamatban...";
            utterance.onend = () => statusMsg.textContent = "Beszéd vége.";
            utterance.onerror = (e) => statusMsg.textContent = "Hiba: " + e.error;

            synth.speak(utterance);
        });

        stopBtn.addEventListener('click', () => {
            synth.cancel();
            statusMsg.textContent = "Megállítva.";
        });

    </script>
</body>
</html>